<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call Transcriber â€” Audio Classification Tool</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=IBM+Plex+Mono:wght@400;500&family=Instrument+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --ink: #1a1a1a;
            --ink-light: #4a4a4a;
            --ink-muted: #8a8a8a;
            --paper: #faf9f7;
            --paper-warm: #f5f3ef;
            --accent: #EC4E36;
            --accent-light: #f06a55;
            --cream: #ebe8e2;
            --border: #d4d0c8;
            --success: #2d5a4a;
            --error: #8b3a3a;
            --warning: #8b6b3a;
            --google-blue: #4285f4;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Instrument Sans', -apple-system, sans-serif;
            background: var(--paper);
            color: var(--ink);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header */
        header {
            background: var(--ink);
            color: var(--paper);
            padding: 2rem 3rem;
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 50%, rgba(45, 90, 74, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 50%, rgba(45, 90, 74, 0.2) 0%, transparent 40%);
            pointer-events: none;
        }

        .header-content {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header-label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: var(--accent-light);
            margin-bottom: 0.5rem;
            opacity: 0;
            animation: fadeSlideDown 0.6s ease forwards;
        }

        h1 {
            font-family: 'DM Serif Display', serif;
            font-size: clamp(2rem, 4vw, 3rem);
            font-weight: 400;
            letter-spacing: -0.02em;
            opacity: 0;
            animation: fadeSlideDown 0.6s ease 0.1s forwards;
        }

        .header-subtitle {
            font-size: 0.95rem;
            color: rgba(250, 249, 247, 0.6);
            margin-top: 0.5rem;
            opacity: 0;
            animation: fadeSlideDown 0.6s ease 0.2s forwards;
        }

        @keyframes fadeSlideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Main Content */
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2.5rem 3rem 4rem;
        }

        /* Sections */
        .section {
            margin-bottom: 2.5rem;
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }

        .section:nth-child(1) { animation-delay: 0.3s; }
        .section:nth-child(2) { animation-delay: 0.4s; }
        .section:nth-child(3) { animation-delay: 0.5s; }
        .section:nth-child(4) { animation-delay: 0.6s; }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .section-header {
            display: flex;
            align-items: baseline;
            gap: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .section-number {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75rem;
            color: var(--ink-muted);
            letter-spacing: 0.05em;
        }

        .section-title {
            font-family: 'DM Serif Display', serif;
            font-size: 1.25rem;
            font-weight: 400;
            color: var(--ink);
        }

        /* Config Grid */
        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .config-card {
            padding: 1.25rem;
            background: var(--paper-warm);
            border: 1px solid var(--border);
            border-radius: 6px;
        }

        .config-card-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--ink-light);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .api-key-row {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .config-hint {
            margin-top: 1rem;
            font-size: 0.8rem;
            color: var(--ink-muted);
        }

        .config-hint a {
            color: var(--accent);
            text-decoration: none;
        }

        .config-hint a:hover {
            text-decoration: underline;
        }

        .input-group {
            flex: 1;
        }

        label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--ink-light);
            margin-bottom: 0.5rem;
            letter-spacing: 0.02em;
        }

        input[type="password"],
        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 0.75rem 1rem;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
            background: white;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--ink);
            transition: all 0.2s ease;
        }

        select {
            font-family: 'Instrument Sans', sans-serif;
            cursor: pointer;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(45, 90, 74, 0.1);
        }

        textarea {
            min-height: 140px;
            resize: vertical;
            line-height: 1.8;
        }

        .input-hint {
            font-size: 0.75rem;
            color: var(--ink-muted);
            margin-top: 0.5rem;
            font-family: 'IBM Plex Mono', monospace;
        }

        /* Status indicators */
        .status-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            margin-top: 0.75rem;
            font-family: 'IBM Plex Mono', monospace;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--ink-muted);
        }

        .status-dot.connected {
            background: var(--success);
        }

        /* Buttons */
        .btn {
            font-family: 'Instrument Sans', sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--paper);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--accent-light);
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--cream);
            color: var(--ink);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-google {
            background: var(--google-blue);
            color: white;
        }

        .btn-google:hover {
            background: #3367d6;
        }

        .btn-ghost {
            background: transparent;
            color: var(--ink-muted);
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
        }

        .btn-ghost:hover {
            color: var(--error);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        /* Google Sign In */
        .google-status {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--ink-light);
        }

        .user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        /* Client Selection */
        .client-select-row {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        /* Sheet Preview */
        .sheet-preview {
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--paper-warm);
            border: 1px solid var(--border);
            border-radius: 6px;
            display: none;
        }

        .sheet-preview.visible {
            display: block;
        }

        .sheet-stats {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.8rem;
            color: var(--ink-light);
        }

        .sheet-stats span {
            color: var(--accent);
            font-weight: 500;
        }

        /* Source Tabs */
        .source-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .source-tab {
            padding: 0.75rem 1.25rem;
            background: var(--cream);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .source-tab:hover {
            background: var(--border);
        }

        .source-tab.active {
            background: var(--accent);
            color: var(--paper);
            border-color: var(--accent);
        }

        /* Main Tabs */
        .main-tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid var(--border);
            margin-bottom: 2rem;
        }

        .main-tab {
            padding: 1rem 1.5rem;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--ink-muted);
            position: relative;
            transition: all 0.2s ease;
        }

        .main-tab:hover {
            color: var(--ink);
        }

        .main-tab.active {
            color: var(--accent);
        }

        .main-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent);
        }

        .main-tab-content {
            display: none;
        }

        .main-tab-content.active {
            display: block;
        }

        /* Config status indicator in tab */
        .config-status {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            margin-left: 0.5rem;
            font-size: 0.75rem;
        }

        .config-status .status-dot {
            width: 6px;
            height: 6px;
        }

        /* Instructions */
        .instructions {
            background: var(--paper-warm);
            border: 1px solid var(--border);
            border-left: 3px solid var(--accent);
            border-radius: 4px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
        }

        .instructions-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--ink);
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .instructions ol {
            margin: 0;
            padding-left: 1.25rem;
            font-size: 0.85rem;
            color: var(--ink-light);
        }

        .instructions li {
            margin-bottom: 0.4rem;
            line-height: 1.5;
        }

        .instructions li:last-child {
            margin-bottom: 0;
        }

        .instructions code {
            background: white;
            padding: 0.1rem 0.4rem;
            border-radius: 3px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.8rem;
            border: 1px solid var(--border);
        }

        .source-content {
            display: none;
        }

        .source-content.active {
            display: block;
        }

        /* Actions Row */
        .actions-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }

        /* Progress */
        .progress-container {
            display: none;
            margin-top: 1.5rem;
            padding: 1.25rem;
            background: var(--paper-warm);
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .progress-container.visible {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .progress-label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.8rem;
            color: var(--ink-light);
        }

        .progress-count {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.8rem;
            color: var(--accent);
            font-weight: 500;
        }

        .progress-bar {
            height: 4px;
            background: var(--cream);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-status {
            font-size: 0.8rem;
            color: var(--ink-muted);
            margin-top: 0.75rem;
            font-style: italic;
        }

        /* Results Section */
        .results-section {
            display: none;
        }

        .results-section.visible {
            display: block;
        }

        .results-actions {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
            flex-wrap: wrap;
        }

        .success-banner {
            padding: 1rem 1.25rem;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 6px;
            color: #155724;
            margin-bottom: 1.25rem;
            display: none;
        }

        .success-banner.visible {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .success-banner a {
            color: #155724;
            font-weight: 500;
        }

        /* Table */
        .table-container {
            background: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
        }

        .table-scroll {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        thead {
            background: var(--ink);
            color: var(--paper);
        }

        th {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            font-weight: 500;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            text-align: left;
            padding: 1rem 1.25rem;
        }

        td {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--cream);
            vertical-align: top;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tbody tr {
            transition: background 0.15s ease;
        }

        tbody tr:nth-child(even) {
            background: var(--paper-warm);
        }

        tbody tr:hover {
            background: var(--cream);
        }

        .url-cell {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75rem;
            word-break: break-all;
            color: var(--ink-light);
            max-width: 200px;
        }

        .transcript-cell {
            font-size: 0.85rem;
            line-height: 1.7;
            color: var(--ink);
            max-width: 400px;
        }

        .formula-cell code {
            display: block;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            background: var(--paper-warm);
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            border: 1px solid var(--border);
            word-break: break-all;
            color: var(--accent);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--ink);
            color: var(--paper);
            padding: 1rem 1.5rem;
            border-radius: 6px;
            font-size: 0.875rem;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toast.visible {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast-icon {
            font-size: 1.1rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            header { padding: 1.5rem; }
            main { padding: 1.5rem; }
            .config-grid { grid-template-columns: 1fr; }
            .api-key-row { flex-direction: column; }
            .client-select-row { flex-direction: column; }
            .source-tabs { flex-direction: column; }
            .actions-row { flex-direction: column; }
            .btn { justify-content: center; }
            th, td { padding: 0.75rem; }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="header-label">Sixth City Marketing</div>
            <h1>Call Transcriber</h1>
            <p class="header-subtitle">Transcribe and classify call recordings</p>
        </div>
    </header>

    <main>
        <!-- Main Tabs -->
        <div class="main-tabs">
            <button class="main-tab active" data-tab="transcribe">Transcribe</button>
            <button class="main-tab" data-tab="settings">
                Settings
                <span class="config-status" id="configStatus">
                    <span class="status-dot" id="configDot"></span>
                </span>
            </button>
        </div>

        <!-- Transcribe Tab -->
        <div class="main-tab-content active" id="transcribeTab">
            <!-- Client Selection Section -->
            <section class="section">
                <div class="section-header">
                    <span class="section-number">01</span>
                    <h2 class="section-title">Select Client & Load Data</h2>
                </div>

            <div class="source-tabs">
                <button class="source-tab active" data-source="client">From Client Sheet</button>
                <button class="source-tab" data-source="manual">Paste URLs Manually</button>
            </div>

            <!-- Client Sheet Source -->
            <div class="source-content active" id="clientSource">
                <div class="client-select-row">
                    <div class="input-group">
                        <label for="clientSelect">Client</label>
                        <select id="clientSelect">
                            <option value="">-- Select a client --</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary" id="loadSheetBtn" disabled>Load Sheet Data</button>
                </div>

                <div class="sheet-preview" id="sheetPreview">
                    <div class="sheet-stats">
                        Found <span id="recordingCount">0</span> calls with recordings ready to process
                    </div>
                    <div class="sheet-stats" id="columnInfo" style="display: none; margin-top: 0.5rem;"></div>
                </div>
            </div>

            <!-- Manual URL Source -->
            <div class="source-content" id="manualSource">
                <div class="input-group">
                    <label for="urlInput">Paste audio URLs (one per line)</label>
                    <textarea id="urlInput" placeholder="https://app.callrail.com/calls/.../recording/redirect?access_key=...&#10;https://app.callrail.com/calls/.../recording/redirect?access_key=..."></textarea>
                    <p class="input-hint">Supported: MP3, WAV, M4A, FLAC, OGG, and more</p>
                </div>
            </div>

            <div class="actions-row">
                <button class="btn btn-primary" id="processBtn" disabled>
                    Process Recordings
                </button>
            </div>

            <div class="progress-container" id="progressContainer">
                <div class="progress-header">
                    <span class="progress-label">Processing</span>
                    <span class="progress-count" id="progressCount">0 / 0</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p class="progress-status" id="progressStatus">Initializing...</p>
            </div>
            </section>

            <!-- Results Section -->
            <section class="section results-section" id="resultsSection">
                <div class="section-header">
                    <span class="section-number">02</span>
                    <h2 class="section-title">Results</h2>
                </div>

                <div class="instructions">
                    <div class="instructions-title">Final Step</div>
                    <ol>
                        <li>Open your Google Sheet</li>
                        <li>Select the entire Category column (with the <code>=AI()</code> formulas)</li>
                        <li>Click <strong>Generate</strong> to classify each call</li>
                    </ol>
                </div>

            <div class="success-banner" id="successBanner">
                <span>âœ“</span>
                <span>Results written to Google Sheet! <a id="sheetLink" href="#" target="_blank">Open Sheet</a></span>
            </div>

            <div class="results-actions">
                <button class="btn btn-secondary" id="copyColumnsBtn">
                    <span>ðŸ“‹</span> Copy Transcript + Category Columns
                </button>
                <button class="btn btn-secondary" id="copyTableBtn">
                    <span>ðŸ“‹</span> Copy Full Table
                </button>
                <button class="btn btn-secondary" id="exportBtn">
                    <span>ðŸ“¥</span> Export CSV
                </button>
            </div>

            <div class="table-container">
                <div class="table-scroll">
                    <table id="resultsTable">
                        <thead>
                            <tr>
                                <th>Row</th>
                                <th>Transcript</th>
                                <th>Category Formula</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                        </tbody>
                    </table>
                </div>
            </div>
            </section>
        </div>

        <!-- Settings Tab -->
        <div class="main-tab-content" id="settingsTab">
            <section class="section">
                <div class="section-header">
                    <span class="section-number">01</span>
                    <h2 class="section-title">Sheet Setup</h2>
                </div>

                <div class="instructions">
                    <div class="instructions-title">Before You Start</div>
                    <ol>
                        <li>Import your CallRail spreadsheet into Google Sheets (select <code>Insert new sheet(s)</code>)</li>
                        <li>Delete the cover sheet</li>
                        <li>Drag the <code>Calls</code> tab to the leftmost position</li>
                        <li>Rename it with the month and year (e.g., <code>Jan 25</code>)</li>
                    </ol>
                </div>
            </section>

            <section class="section">
                <div class="section-header">
                    <span class="section-number">02</span>
                    <h2 class="section-title">API Configuration</h2>
                </div>

                <div class="config-grid">
                    <!-- Deepgram API Key -->
                    <div class="config-card">
                        <div class="config-card-title">Deepgram API</div>
                        <div class="api-key-row">
                            <div class="input-group">
                                <label for="deepgramKey">API Key</label>
                                <input type="password" id="deepgramKey" placeholder="Enter Deepgram key..." autocomplete="off">
                            </div>
                            <button class="btn btn-secondary btn-small" id="saveDeepgramBtn">Save</button>
                            <button class="btn btn-ghost btn-small" id="clearDeepgramBtn">Clear</button>
                        </div>
                        <div class="status-row">
                            <span class="status-dot" id="deepgramDot"></span>
                            <span id="deepgramText">No key saved</span>
                        </div>
                    </div>

                    <!-- Google Account -->
                    <div class="config-card">
                        <div class="config-card-title">Google Sheets Access</div>
                        <div class="google-status" id="googleStatus">
                            <button class="btn btn-google" id="googleSignInBtn">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#fff"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#fff"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#fff"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#fff"/></svg>
                                Sign in with Google
                            </button>
                        </div>
                        <p class="config-hint">Required to automatically write results to your sheets.</p>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Toast -->
    <div class="toast" id="toast">
        <span class="toast-icon" id="toastIcon">âœ“</span>
        <span id="toastMessage">Success</span>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        // Pre-configured clients (add more as needed)
        const DEFAULT_CLIENTS = [
            {
                name: 'Hoosier Hauler',
                sheetId: '1GynGC-Kb5c2umvxfC_8nRzxJ68Kdn8kYORupsCe7haY',
                url: 'https://docs.google.com/spreadsheets/d/1GynGC-Kb5c2umvxfC_8nRzxJ68Kdn8kYORupsCe7haY/edit',
                categories: ['Porta Potty', 'Dumpster', 'Voicemail', 'Job Application', 'Other']
            },
            {
                name: 'Stockman Lawnscapes',
                sheetId: '1A1SN5QVtF8pdYdpgZKPSdKkhxSEEzSWkcQzse5GOtU0',
                url: 'https://docs.google.com/spreadsheets/d/1A1SN5QVtF8pdYdpgZKPSdKkhxSEEzSWkcQzse5GOtU0/edit',
                categories: ['Lawn Care', 'Hardscaping', 'Outdoor Living', 'Erosion Control', 'Drainage', 'Winter Services', 'General Landscaping', 'Voicemail', 'Job Application', 'Other']
            }
            // Add more clients here:
            // { name: 'Client Name', sheetId: 'SHEET_ID', url: 'FULL_URL', categories: [] }
        ];

        // Google OAuth Client ID
        const GOOGLE_CLIENT_ID = '751776580622-ljmlv6rhl94o0ivommkdvpue8vm05i7u.apps.googleusercontent.com';

        // Build AI prompt based on client categories
        function getAIPrompt(client) {
            if (client && client.categories && client.categories.length > 0) {
                const cats = client.categories.join(', ');
                return `Categorize this call transcript. Reply with ONLY one of these categories: ${cats}. If it's a voicemail or job inquiry, use those categories. If unclear, reply "Other".`;
            }
            return "Read this call transcript and identify the main topic. Reply with a short category label (2-4 words max), nothing else.";
        }

        // Column indexes will be determined dynamically based on sheet structure
        let TRANSCRIPT_COL = null;
        let CATEGORY_COL = null;

        // ==================== STATE ====================
        let results = [];
        let sheetData = [];
        let isProcessing = false;
        let currentSource = 'client';
        let selectedClient = null;
        let googleAccessToken = null;
        let googleUser = null;
        let detectedSheetName = 'Calls'; // Will be updated when loading sheet

        // ==================== DOM ELEMENTS ====================
        const deepgramKeyInput = document.getElementById('deepgramKey');
        const saveDeepgramBtn = document.getElementById('saveDeepgramBtn');
        const clearDeepgramBtn = document.getElementById('clearDeepgramBtn');
        const deepgramDot = document.getElementById('deepgramDot');
        const deepgramText = document.getElementById('deepgramText');

        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const googleStatus = document.getElementById('googleStatus');

        const clientSelect = document.getElementById('clientSelect');
        const loadSheetBtn = document.getElementById('loadSheetBtn');
        const sheetPreview = document.getElementById('sheetPreview');
        const recordingCount = document.getElementById('recordingCount');

        const mainTabs = document.querySelectorAll('.main-tab');
        const mainTabContents = document.querySelectorAll('.main-tab-content');
        const configDot = document.getElementById('configDot');

        const sourceTabs = document.querySelectorAll('.source-tab');
        const sourceContents = document.querySelectorAll('.source-content');

        const urlInput = document.getElementById('urlInput');
        const processBtn = document.getElementById('processBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressCount = document.getElementById('progressCount');
        const progressFill = document.getElementById('progressFill');
        const progressStatus = document.getElementById('progressStatus');

        const resultsSection = document.getElementById('resultsSection');
        const resultsBody = document.getElementById('resultsBody');
        const successBanner = document.getElementById('successBanner');
        const sheetLink = document.getElementById('sheetLink');
        const copyColumnsBtn = document.getElementById('copyColumnsBtn');
        const copyTableBtn = document.getElementById('copyTableBtn');
        const exportBtn = document.getElementById('exportBtn');

        const toast = document.getElementById('toast');
        const toastIcon = document.getElementById('toastIcon');
        const toastMessage = document.getElementById('toastMessage');

        // ==================== INITIALIZATION ====================
        function init() {
            loadDeepgramKey();
            populateClientSelect();
            setupEventListeners();
            initGoogleAuth();
            updateProcessButton();
            updateConfigStatus();
        }

        function updateConfigStatus() {
            const hasDeepgram = deepgramKeyInput.value.trim().length > 0;
            const hasGoogle = googleAccessToken !== null;
            if (hasDeepgram && hasGoogle) {
                configDot.classList.add('connected');
            } else {
                configDot.classList.remove('connected');
            }
        }

        function loadDeepgramKey() {
            const saved = localStorage.getItem('deepgram_api_key');
            if (saved) {
                deepgramKeyInput.value = saved;
                updateDeepgramStatus(true);
            }
        }

        function updateDeepgramStatus(saved) {
            if (saved) {
                deepgramDot.classList.add('connected');
                deepgramText.textContent = 'Key saved locally';
            } else {
                deepgramDot.classList.remove('connected');
                deepgramText.textContent = 'No key saved';
            }
        }

        function populateClientSelect() {
            clientSelect.innerHTML = '<option value="">-- Select a client --</option>' +
                DEFAULT_CLIENTS.map((client, i) =>
                    `<option value="${i}">${client.name}</option>`
                ).join('');
        }

        function setupEventListeners() {
            // Deepgram
            saveDeepgramBtn.addEventListener('click', () => {
                const key = deepgramKeyInput.value.trim();
                if (key) {
                    localStorage.setItem('deepgram_api_key', key);
                    updateDeepgramStatus(true);
                    showToast('Deepgram key saved', 'âœ“');
                }
                updateProcessButton();
                updateConfigStatus();
            });

            clearDeepgramBtn.addEventListener('click', () => {
                localStorage.removeItem('deepgram_api_key');
                deepgramKeyInput.value = '';
                updateDeepgramStatus(false);
                showToast('Deepgram key cleared', 'âœ“');
                updateProcessButton();
                updateConfigStatus();
            });

            deepgramKeyInput.addEventListener('input', updateProcessButton);

            // Main tabs
            mainTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;
                    mainTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    mainTabContents.forEach(c => c.classList.remove('active'));
                    document.getElementById(tabId + 'Tab').classList.add('active');
                });
            });

            // Google Sign In
            googleSignInBtn.addEventListener('click', handleGoogleSignIn);

            // Source tabs
            sourceTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    currentSource = tab.dataset.source;
                    sourceTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    sourceContents.forEach(c => c.classList.remove('active'));
                    document.getElementById(currentSource + 'Source').classList.add('active');
                    updateProcessButton();
                });
            });

            // Client select
            clientSelect.addEventListener('change', () => {
                const idx = clientSelect.value;
                selectedClient = idx !== '' ? DEFAULT_CLIENTS[idx] : null;
                sheetPreview.classList.remove('visible');
                sheetData = [];
                loadSheetBtn.disabled = !selectedClient;
                updateProcessButton();
            });

            loadSheetBtn.addEventListener('click', loadGoogleSheet);
            urlInput.addEventListener('input', updateProcessButton);

            processBtn.addEventListener('click', processRecordings);
            copyColumnsBtn.addEventListener('click', copyColumnsToClipboard);
            copyTableBtn.addEventListener('click', copyTableToClipboard);
            exportBtn.addEventListener('click', exportToCSV);
        }

        function updateProcessButton() {
            const hasDeepgram = deepgramKeyInput.value.trim().length > 0;
            let hasData = currentSource === 'client' ? sheetData.length > 0 : urlInput.value.trim().length > 0;
            processBtn.disabled = !hasDeepgram || !hasData || isProcessing;
        }

        // ==================== GOOGLE AUTH ====================
        function initGoogleAuth() {
            // Check if we have a stored token
            const storedToken = sessionStorage.getItem('google_access_token');
            if (storedToken) {
                googleAccessToken = storedToken;
                updateGoogleStatus(true);
                updateConfigStatus();
            }
        }

        function handleGoogleSignIn() {
            if (GOOGLE_CLIENT_ID === 'YOUR_CLIENT_ID_HERE.apps.googleusercontent.com') {
                showToast('Google Client ID not configured. Using manual copy mode.', 'âš ï¸');
                return;
            }

            const client = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/spreadsheets',
                callback: (response) => {
                    if (response.access_token) {
                        googleAccessToken = response.access_token;
                        sessionStorage.setItem('google_access_token', response.access_token);
                        updateGoogleStatus(true);
                        updateConfigStatus();
                        showToast('Signed in to Google', 'âœ“');
                    }
                }
            });
            client.requestAccessToken();
        }

        function updateGoogleStatus(signedIn) {
            if (signedIn) {
                googleStatus.innerHTML = `
                    <div class="status-row">
                        <span class="status-dot connected"></span>
                        <span>Connected to Google Sheets</span>
                    </div>
                    <button class="btn btn-ghost btn-small" id="googleSignOutBtn">Sign Out</button>
                `;
                document.getElementById('googleSignOutBtn').addEventListener('click', () => {
                    googleAccessToken = null;
                    sessionStorage.removeItem('google_access_token');
                    updateGoogleStatus(false);
                    updateConfigStatus();
                    showToast('Signed out of Google', 'âœ“');
                });
            } else {
                googleStatus.innerHTML = `
                    <button class="btn btn-google" id="googleSignInBtn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#fff"/></svg>
                        Sign in with Google
                    </button>
                `;
                document.getElementById('googleSignInBtn').addEventListener('click', handleGoogleSignIn);
            }
        }

        // ==================== GOOGLE SHEETS ====================
        async function getFirstSheetName() {
            // Use Google Sheets API to get the actual first sheet name
            if (!googleAccessToken || !selectedClient) return null;

            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${selectedClient.sheetId}?fields=sheets.properties`,
                    {
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`
                        }
                    }
                );

                if (response.ok) {
                    const data = await response.json();
                    // Return the first (leftmost) sheet name
                    if (data.sheets && data.sheets.length > 0) {
                        return data.sheets[0].properties.title;
                    }
                }
            } catch (e) {
                console.log('Could not fetch sheet metadata:', e);
            }
            return null;
        }

        async function loadGoogleSheet() {
            if (!selectedClient) return;

            loadSheetBtn.disabled = true;
            loadSheetBtn.textContent = 'Loading...';

            try {
                // First, try to get the actual first sheet name via API
                const firstSheetName = await getFirstSheetName();
                if (firstSheetName) {
                    detectedSheetName = firstSheetName;
                    console.log('Using first sheet:', detectedSheetName);
                }

                // Fetch CSV data using the detected sheet name (or default to first sheet)
                let csvText = null;

                if (detectedSheetName) {
                    const csvUrl = `https://docs.google.com/spreadsheets/d/${selectedClient.sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(detectedSheetName)}`;
                    const response = await fetch(csvUrl);
                    if (response.ok) {
                        csvText = await response.text();
                    }
                }

                // Fallback: try without sheet parameter (uses first sheet)
                if (!csvText) {
                    const csvUrl = `https://docs.google.com/spreadsheets/d/${selectedClient.sheetId}/gviz/tq?tqx=out:csv`;
                    const response = await fetch(csvUrl);
                    if (!response.ok) {
                        throw new Error('Failed to fetch sheet. Make sure it\'s shared publicly.');
                    }
                    csvText = await response.text();
                    // If we didn't get the name from API, we need to detect it
                    if (!detectedSheetName) {
                        detectedSheetName = 'Sheet1';
                    }
                }
                const rows = parseCSV(csvText);

                if (rows.length < 2) throw new Error('Sheet appears to be empty');

                // Find Recording URL column
                const headers = rows[0];
                const recordingColIndex = headers.findIndex(h =>
                    h.toLowerCase().includes('recording') && h.toLowerCase().includes('url')
                );

                if (recordingColIndex === -1) {
                    throw new Error('Could not find "Recording Url" column');
                }

                // Check if Transcript/Category columns already exist, otherwise add after last column
                const transcriptColIndex = headers.findIndex(h =>
                    h.toLowerCase() === 'transcript'
                );
                const categoryColIndex = headers.findIndex(h =>
                    h.toLowerCase() === 'category'
                );

                if (transcriptColIndex !== -1) {
                    // Use existing columns
                    TRANSCRIPT_COL = transcriptColIndex;
                    CATEGORY_COL = categoryColIndex !== -1 ? categoryColIndex : transcriptColIndex + 1;
                } else {
                    // Add new columns after the last existing column
                    const lastColIndex = headers.length;
                    TRANSCRIPT_COL = lastColIndex;
                    CATEGORY_COL = lastColIndex + 1;
                }

                // Extract rows with recording URLs
                sheetData = [];
                for (let i = 1; i < rows.length; i++) {
                    const url = rows[i][recordingColIndex];
                    if (url && url.trim() && url.startsWith('http')) {
                        sheetData.push({
                            rowIndex: i + 1,
                            url: url.trim()
                        });
                    }
                }

                recordingCount.textContent = sheetData.length;

                // Show which columns will be used
                const transcriptColLetter = colLetter(TRANSCRIPT_COL);
                const categoryColLetter = colLetter(CATEGORY_COL);
                document.getElementById('columnInfo').textContent =
                    `Sheet: "${detectedSheetName}" | Transcript â†’ Column ${transcriptColLetter}, Category â†’ Column ${categoryColLetter}`;
                document.getElementById('columnInfo').style.display = 'block';

                sheetPreview.classList.add('visible');
                showToast(`Loaded ${sheetData.length} recordings`, 'âœ“');
                updateProcessButton();

            } catch (error) {
                showToast(error.message, 'âŒ');
                sheetData = [];
            } finally {
                loadSheetBtn.disabled = false;
                loadSheetBtn.textContent = 'Load Sheet Data';
            }
        }

        async function writeResultsToSheet() {
            if (!googleAccessToken || !selectedClient || results.length === 0) return false;

            try {
                progressStatus.textContent = 'Writing results to Google Sheet...';

                // Prepare batch update data - start with headers in row 1
                const data = [
                    {
                        range: `'${detectedSheetName}'!${colLetter(TRANSCRIPT_COL)}1:${colLetter(CATEGORY_COL)}1`,
                        values: [['Transcript', 'Category']]
                    },
                    ...results.map(r => ({
                        range: `'${detectedSheetName}'!${colLetter(TRANSCRIPT_COL)}${r.rowIndex}:${colLetter(CATEGORY_COL)}${r.rowIndex}`,
                        values: [[
                            r.transcript,
                            r.isError ? '' : `=AI("${getAIPrompt(selectedClient)}", ${colLetter(TRANSCRIPT_COL)}${r.rowIndex})`
                        ]]
                    }))
                ];

                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${selectedClient.sheetId}/values:batchUpdate`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            valueInputOption: 'USER_ENTERED',
                            data: data
                        })
                    }
                );

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'Failed to write to sheet');
                }

                return true;
            } catch (error) {
                console.error('Failed to write to sheet:', error);
                showToast('Failed to write to sheet. Use copy buttons instead.', 'âš ï¸');
                return false;
            }
        }

        function colLetter(colIndex) {
            let letter = '';
            while (colIndex >= 0) {
                letter = String.fromCharCode(65 + (colIndex % 26)) + letter;
                colIndex = Math.floor(colIndex / 26) - 1;
            }
            return letter;
        }

        function parseCSV(text) {
            const rows = [];
            let currentRow = [];
            let currentCell = '';
            let insideQuotes = false;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];

                if (char === '"') {
                    if (insideQuotes && nextChar === '"') {
                        currentCell += '"';
                        i++;
                    } else {
                        insideQuotes = !insideQuotes;
                    }
                } else if (char === ',' && !insideQuotes) {
                    currentRow.push(currentCell);
                    currentCell = '';
                } else if ((char === '\n' || (char === '\r' && nextChar === '\n')) && !insideQuotes) {
                    currentRow.push(currentCell);
                    rows.push(currentRow);
                    currentRow = [];
                    currentCell = '';
                    if (char === '\r') i++;
                } else if (char !== '\r') {
                    currentCell += char;
                }
            }

            if (currentCell || currentRow.length > 0) {
                currentRow.push(currentCell);
                rows.push(currentRow);
            }

            return rows;
        }

        // ==================== PROCESSING ====================
        async function processRecordings() {
            const deepgramKey = deepgramKeyInput.value.trim();

            let urlsToProcess = [];
            if (currentSource === 'client') {
                urlsToProcess = sheetData.map(d => ({ url: d.url, rowIndex: d.rowIndex }));
            } else {
                const urls = urlInput.value.split('\n').map(u => u.trim()).filter(u => u.length > 0);
                urlsToProcess = urls.map((url, i) => ({ url, rowIndex: i + 2 }));
            }

            if (!deepgramKey || urlsToProcess.length === 0) return;

            isProcessing = true;
            results = [];
            processBtn.disabled = true;
            progressContainer.classList.add('visible');
            resultsSection.classList.remove('visible');
            successBanner.classList.remove('visible');

            for (let i = 0; i < urlsToProcess.length; i++) {
                const { url, rowIndex } = urlsToProcess[i];
                progressCount.textContent = `${i + 1} / ${urlsToProcess.length}`;
                progressFill.style.width = `${(i / urlsToProcess.length) * 100}%`;

                try {
                    progressStatus.textContent = `Transcribing ${i + 1}/${urlsToProcess.length}...`;
                    const transcript = await transcribeFromUrl(url, deepgramKey);

                    results.push({ url, rowIndex, transcript });
                } catch (error) {
                    console.error(`Error processing ${url}:`, error);
                    results.push({ url, rowIndex, transcript: `Error: ${error.message}`, isError: true });
                }

                progressFill.style.width = `${((i + 1) / urlsToProcess.length) * 100}%`;
            }

            // Try to write to sheet if signed in
            let wroteToSheet = false;
            if (googleAccessToken && currentSource === 'client' && selectedClient) {
                wroteToSheet = await writeResultsToSheet();
            }

            progressStatus.textContent = 'Processing complete!';
            isProcessing = false;
            processBtn.disabled = false;

            setTimeout(() => {
                progressContainer.classList.remove('visible');
                displayResults(wroteToSheet);
            }, 1000);
        }

        async function transcribeFromUrl(audioUrl, deepgramKey) {
            // Use Deepgram's URL-based transcription - they fetch the audio directly
            // This bypasses CORS issues since Deepgram's servers fetch the audio
            const response = await fetch('https://api.deepgram.com/v1/listen?model=nova-2&language=en&punctuate=true&smart_format=true', {
                method: 'POST',
                headers: {
                    'Authorization': `Token ${deepgramKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: audioUrl })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.err_msg || error.error || 'Transcription failed');
            }

            const data = await response.json();
            const transcript = data.results?.channels?.[0]?.alternatives?.[0]?.transcript;
            if (!transcript) throw new Error('No transcript returned');
            return transcript;
        }

        // ==================== RESULTS ====================
        function displayResults(wroteToSheet) {
            resultsBody.innerHTML = '';

            results.forEach(result => {
                const row = document.createElement('tr');
                const formula = result.isError ? 'N/A' : `=AI("${getAIPrompt(selectedClient)}", ${colLetter(TRANSCRIPT_COL)}${result.rowIndex})`;

                row.innerHTML = `
                    <td>${result.rowIndex}</td>
                    <td class="transcript-cell">${escapeHtml(result.transcript)}</td>
                    <td class="formula-cell"><code>${escapeHtml(formula)}</code></td>
                `;
                resultsBody.appendChild(row);
            });

            if (wroteToSheet && selectedClient) {
                sheetLink.href = selectedClient.url;
                successBanner.classList.add('visible');
            }

            resultsSection.classList.add('visible');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== EXPORT ====================
        function copyColumnsToClipboard() {
            if (results.length === 0) return;

            const maxRow = Math.max(...results.map(r => r.rowIndex));
            const outputRows = new Array(maxRow).fill(null).map(() => ['', '']);

            results.forEach(r => {
                const clean = r.transcript.replace(/\t/g, ' ').replace(/\n/g, ' ');
                const formula = r.isError ? '' : `=AI("${getAIPrompt(selectedClient)}", ${colLetter(TRANSCRIPT_COL)}${r.rowIndex})`;
                outputRows[r.rowIndex - 1] = [clean, formula];
            });

            let text = 'Transcript\tCategory\n';
            outputRows.forEach(row => { text += `${row[0]}\t${row[1]}\n`; });

            navigator.clipboard.writeText(text).then(() => {
                showToast('Columns copied!', 'ðŸ“‹');
            });
        }

        function copyTableToClipboard() {
            if (results.length === 0) return;

            let text = 'Row\tTranscript\tCategory\n';
            results.forEach(r => {
                const clean = r.transcript.replace(/\t/g, ' ').replace(/\n/g, ' ');
                const formula = r.isError ? 'N/A' : `=AI("${getAIPrompt(selectedClient)}", ${colLetter(TRANSCRIPT_COL)}${r.rowIndex})`;
                text += `${r.rowIndex}\t${clean}\t${formula}\n`;
            });

            navigator.clipboard.writeText(text).then(() => {
                showToast('Table copied!', 'ðŸ“‹');
            });
        }

        function exportToCSV() {
            if (results.length === 0) return;

            const csvContent = [
                ['Row', 'Transcript', 'Category'],
                ...results.map(r => {
                    const formula = r.isError ? 'N/A' : `=AI("${getAIPrompt(selectedClient)}", ${colLetter(TRANSCRIPT_COL)}${r.rowIndex})`;
                    return [r.rowIndex, r.transcript.replace(/"/g, '""'), formula];
                })
            ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `transcriptions-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            showToast('CSV downloaded', 'ðŸ“¥');
        }

        function showToast(message, icon = 'âœ“') {
            toastMessage.textContent = message;
            toastIcon.textContent = icon;
            toast.classList.add('visible');
            setTimeout(() => toast.classList.remove('visible'), 3000);
        }

        // Initialize
        init();
    </script>
</body>
</html>
